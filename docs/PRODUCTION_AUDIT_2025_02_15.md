# Production Audit ‚Äî 2025-02-15 (Deep Static Analysis)

## Executive Summary

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö | –°—Ä–µ–¥–Ω–∏—Ö | –ò–Ω—Ñ–æ—Ä–º. | –ò—Ç–æ–≥–æ |
|-----------|------------|---------|---------|-------|
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (DB/RLS)** | 5 | 8 | 4 | 17 |
| **Edge Functions** | 1 | 2 | 0 | 3 |
| **–ö–æ–¥ (Frontend)** | 0 | 3 | 2 | 5 |
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | 0 | 2 | 1 | 3 |
| **–ò—Ç–æ–≥–æ** | **6** | **15** | **7** | **28** |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞**: –ü—Ä–æ–µ–∫—Ç production-ready —Å —Ö–æ—Ä–æ—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –ø–µ—Ä–∏–º–µ—Ç—Ä–∞ (CORS fail-closed, internal-key, JWT). –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ ‚Äî –≤ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç–∏ RLS-–ø–æ–ª–∏—Ç–∏–∫ –∏ –æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö console.log –≤ production-–∫–æ–¥–µ.

---

## 1. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (üî¥)

### 1.1 Extensions –≤ public-—Å—Ö–µ–º–µ
- **–ß—Ç–æ**: pg_trgm –∏ pgvector —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ `public` –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ö–µ–º—ã
- **–†–∏—Å–∫**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å; —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—ã–∑–æ–≤–∞ —á–µ—Ä–µ–∑ PostgREST
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ —Å—Ö–µ–º—É `extensions` (`CREATE EXTENSION pg_trgm SCHEMA extensions`)
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: –°—Ä–µ–¥–Ω—è—è (–Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫)

### 1.2 RLS Policy Always True (WARN #3)
- **–ß—Ç–æ**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ —Å `USING (true)` –∏–ª–∏ `WITH CHECK (true)` –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö INSERT/UPDATE/DELETE
- **–†–∏—Å–∫**: –õ—é–±–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ (`auth.uid() = user_id`)

### 1.3 Leaked Password Protection –æ—Ç–∫–ª—é—á–µ–Ω–∞
- **–ß—Ç–æ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π –ø–æ –±–∞–∑–∞–º —É—Ç–µ—á–µ–∫ (HaveIBeenPwned) –æ—Ç–∫–ª—é—á–µ–Ω–∞
- **–†–∏—Å–∫**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í–∫–ª—é—á–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 1.4 –ü—Ä–æ—Ñ–∏–ª–∏ ‚Äî —à–∏—Ä–æ–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ PII
- **–ß—Ç–æ**: –ê–¥–≤–æ–∫–∞—Ç—ã –≤–∏–¥—è—Ç –ø—Ä–æ—Ñ–∏–ª–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, –∞–¥–º–∏–Ω—ã ‚Äî –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ (email, —Ç–µ–ª–µ—Ñ–æ–Ω, –§–ò–û)
- **–†–∏—Å–∫**: –£—Ç–µ—á–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –∞–¥–≤–æ–∫–∞—Ç–∞/–∞–¥–º–∏–Ω–∞
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–æ–ª–µ-—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å: —Å–∫—Ä—ã–≤–∞—Ç—å email/phone/encrypted_address –¥–ª—è —Ä–æ–ª–µ–π –±–µ–∑ –ø—Ä—è–º–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 1.5 Encrypted PII ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∞—Ä—å–µ—Ä RLS
- **–ß—Ç–æ**: –¢–∞–±–ª–∏—Ü–∞ `encrypted_pii` –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ RLS; –∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–∏—Å–∫**: –ü—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è + –∞–¥–º–∏–Ω-–∞–∫–∫–∞—É–Ω—Ç–∞ ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ PII
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: Application-level key rotation, –∞—É–¥–∏—Ç-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ

---

## 2. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ‚Äî –°–†–ï–î–ù–ò–ï (üü°)

### 2.1 Audit Logs ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π INSERT
- **–ü–æ–ª–∏—Ç–∏–∫–∞**: `WITH CHECK (auth.uid() = user_id)` –Ω–∞ INSERT
- **–†–∏—Å–∫**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –ª–æ–∂–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –∞—É–¥–∏—Ç-–ª–æ–≥
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: INSERT —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `SECURITY DEFINER` —Ñ—É–Ω–∫—Ü–∏—é `log_audit()`; —É–±—Ä–∞—Ç—å –ø—Ä—è–º–æ–π INSERT

### 2.2 Error Logs ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π INSERT (user_id = NULL —Ä–∞–∑—Ä–µ—à—ë–Ω)
- **–†–∏—Å–∫**: –§–ª—É–¥ –ª–æ–∂–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ RPC

### 2.3 API Usage ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π INSERT
- **–†–∏—Å–∫**: –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è –±–∏–ª–ª–∏–Ω–≥–æ–º / —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: INSERT —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `SECURITY DEFINER` RPC

### 2.4 Notifications ‚Äî INSERT –±–µ–∑ user_id = auth.uid()
- **–ß—Ç–æ**: `auth.uid() IS NOT NULL` –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É user_id
- **–†–∏—Å–∫**: –°–ø–∞–º –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: `WITH CHECK (auth.uid() = user_id)`

### 2.5 Telegram Uploads ‚Äî —Ç–∞–≤—Ç–æ–ª–æ–≥–∏—è –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **–ß—Ç–æ**: –£—Å–ª–æ–≤–∏–µ `profiles.telegram_chat_id = profiles.telegram_chat_id` (self-join = –≤—Å–µ–≥–¥–∞ true)
- **–†–∏—Å–∫**: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö chat_id
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–µ–∫—É—â–µ–≥–æ user_id ‚Üí –µ–≥–æ telegram_chat_id

### 2.6 Case Comments ‚Äî is_internal –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ RLS
- **–ß—Ç–æ**: –¢–∏–º–ª–∏–¥—ã –≤–∏–¥—è—Ç –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –≤–∫–ª—é—á–∞—è internal
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ `(NOT is_internal OR author_id = auth.uid() OR has_role(auth.uid(), 'admin'))`

### 2.7 Evidence Registry ‚Äî —à–∏—Ä–æ–∫–∏–π –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ user_can_access_case
- **–ß—Ç–æ**: –§—É–Ω–∫—Ü–∏—è `user_can_access_case` –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø —Ç–∏–º–ª–∏–¥–∞–º –∫ –¥–µ—Ç–∞–ª—è–º –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–µ–µ ‚Äî —Å–∫—Ä—ã–≤–∞—Ç—å defense_arguments –∏ prosecution_position –æ—Ç –Ω–µ–ª–∏–¥–∏—Ä—É—é—â–∏—Ö

### 2.8 AI Analysis / Case Files ‚Äî —Ç–∏–º–ª–∏–¥—ã –≤–∏–¥—è—Ç –≤—Å—ë
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–µ–ª–∞

---

## 3. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ‚Äî –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ï (üîµ)

### 3.1 Document Templates ‚Äî –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º authenticated
- **–°—Ç–∞—Ç—É—Å**: –î–æ–ø—É—Å—Ç–∏–º–æ (—à–∞–±–ª–æ–Ω—ã ‚Äî –æ–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å

### 3.2 Knowledge Base / Legal Documents / Legal Practice KB ‚Äî –ø—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
- **–°—Ç–∞—Ç—É—Å**: –î–æ–ø—É—Å—Ç–∏–º–æ (–±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Äî –æ–±—â–∏–π —Ä–µ—Å—É—Ä—Å)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

---

## 4. EDGE FUNCTIONS (üü°)

### 4.1 legal-chat: Service Role Key –¥–ª—è RAG-–ø–æ–∏—Å–∫–∞
- **–ß—Ç–æ** (—Å—Ç—Ä–æ–∫–∏ 227-228): `const supabase = createClient(supabaseUrl, supabaseServiceKey)` ‚Äî RAG-–ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Service Role
- **–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ**: Memory `rag-authentication-standard` —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è JWT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–†–∏—Å–∫**: –û–±—Ö–æ–¥ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–∞—Ö `legal_chunks`, `knowledge_base`
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sb` (—Å—Ç—Ä–æ–∫–∞ 189) —Å JWT –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è RAG-–∑–∞–ø—Ä–æ—Å–æ–≤; Service Role —Ç–æ–ª—å–∫–æ –¥–ª—è `log_api_usage`
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –°—Ä–µ–¥–Ω–∏–π (RLS –Ω–∞ KB-—Ç–∞–±–ª–∏—Ü–∞—Ö = `is_active = true` –¥–ª—è authenticated, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑–Ω–∏—Ü–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ)

### 4.2 ingest-document: Internal API Key fallback (—Å—Ç—Ä–æ–∫–∞ 169)
- **–ß—Ç–æ**: `INTERNAL_API_KEY || SUPABASE_SERVICE_ROLE_KEY` ‚Äî fallback –Ω–∞ Service Role Key –∫–∞–∫ x-internal-key
- **–†–∏—Å–∫**: Service Role Key –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `INTERNAL_INGEST_KEY`

### 4.3 Config.toml ‚Äî —á–∏—Å—Ç—ã–π ‚úÖ
- –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç
- –í—Å–µ 13 `verify_jwt = false` –∏–º–µ—é—Ç code-level –∑–∞—â–∏—Ç—É
- User-facing endpoints ‚Äî default `verify_jwt = true`

---

## 5. –ö–û–î (FRONTEND) (üü°)

### 5.1 Console.log –≤ production ‚Äî 511 –≤—Ö–æ–∂–¥–µ–Ω–∏–π –≤ 40 —Ñ–∞–π–ª–∞—Ö
- **–ß—Ç–æ**: `console.log/warn/error/debug` —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ production-–∫–æ–¥—É
- **–†–∏—Å–∫**: –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ DevTools; —à—É–º –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: 
  - –û—Å—Ç–∞–≤–∏—Ç—å `console.error` –≤ catch-–±–ª–æ–∫–∞—Ö (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
  - –£–¥–∞–ª–∏—Ç—å `console.log` (–æ—Å–æ–±–µ–Ω–Ω–æ —Å—Ç—Ä–æ–∫–∞ 131 –≤ DocumentFileUpload.tsx ‚Äî –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞)
  - –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ structured logger –∏–ª–∏ —É–±—Ä–∞—Ç—å –∑–∞ `import.meta.env.DEV` guard

### 5.2 dangerouslySetInnerHTML
- **–ì–¥–µ**: –¢–æ–ª—å–∫–æ `src/components/ui/chart.tsx` (shadcn)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥

### 5.3 Remember Me ‚Äî sessionStorage fallback
- **–ì–¥–µ**: Login.tsx —Å—Ç—Ä–æ–∫–∏ 80-88
- **–ß—Ç–æ**: –ü—Ä–∏ `rememberMe = false` —Å–µ—Å—Å–∏—è –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç—Å—è –≤ sessionStorage
- **–†–∏—Å–∫**: –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω; –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ –æ–±–æ–∏—Ö —Ö—Ä–∞–Ω–∏–ª–∏—â–∞—Ö
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–æ —Å—Ç–æ–∏—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å edge-cases

---

## 6. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (üü°)

### 6.1 norm-ref-extractor ‚Äî 286 —Å—Ç—Ä–æ–∫, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
- **–ß—Ç–æ**: –†–µ–≥–µ–∫—Å—ã, —Ç–∏–ø—ã, HTTP-handler –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í—ã–Ω–µ—Å—Ç–∏ `extractNormRefs()` –≤ `_shared/norm-ref-extractor.ts`

### 6.2 legal-chat ‚Äî 380 —Å—Ç—Ä–æ–∫
- **–ß—Ç–æ**: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (164 —Å—Ç—Ä–æ–∫–∏!) + HTTP handler + RAG orchestration –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –í—ã–Ω–µ—Å—Ç–∏ `LEGAL_AI_SYSTEM_PROMPT` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–æ–º–ø—Ç–æ–≤

### 6.3 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ normalizeUsername
- **–ì–¥–µ**: Login.tsx (—Å—Ç—Ä–æ–∫–∏ 47-49 + 56-57) ‚Äî –¥–≤–æ–π–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é

---

## 7. –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –ú–û–ú–ï–ù–¢–´ ‚úÖ

| –ê—Å–ø–µ–∫—Ç | –û—Ü–µ–Ω–∫–∞ |
|--------|--------|
| CORS fail-closed (handleCors) | ‚úÖ –í—Å–µ 26 —Ñ—É–Ω–∫—Ü–∏–π |
| Internal-key –¥–ª—è server-to-server | ‚úÖ 10 —Ñ—É–Ω–∫—Ü–∏–π |
| JWT –¥–ª—è user-facing | ‚úÖ 9 —Ñ—É–Ω–∫—Ü–∏–π |
| Webhook secret (Telegram) | ‚úÖ |
| Input validation (zod, size limits) | ‚úÖ |
| Prompt injection defense | ‚úÖ prompt-armor.ts |
| Token budget limiter | ‚úÖ |
| PII redaction in logs | ‚úÖ safe-logger.ts |
| Lazy loading (React) | ‚úÖ App.tsx |
| Role-based routing (ProtectedRoute) | ‚úÖ Server-side has_role() |
| Audit logging | ‚úÖ log_audit RPC |
| Soft delete (cases, files) | ‚úÖ |
| Embedding lifecycle (status tracking) | ‚úÖ |

---

## 8. –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (P0)
1. ~~–í–∫–ª—é—á–∏—Ç—å leaked password protection~~ ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Auth
2. –ù–∞–π—Ç–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å `RLS Policy Always True` (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É)
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–≤—Ç–æ–ª–æ–≥–∏—é –≤ Telegram Uploads RLS

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (P1, 1-2 –Ω–µ–¥–µ–ª–∏)
4. Audit/Error/API Usage logs ‚Üí INSERT —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SECURITY DEFINER RPC
5. Notifications ‚Üí –¥–æ–±–∞–≤–∏—Ç—å `user_id = auth.uid()` –≤ WITH CHECK
6. legal-chat ‚Üí –∑–∞–º–µ–Ω–∏—Ç—å Service Role –Ω–∞ JWT –¥–ª—è RAG-–∑–∞–ø—Ä–æ—Å–æ–≤
7. ingest-document ‚Üí —É–±—Ä–∞—Ç—å fallback –Ω–∞ Service Role Key

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (P2, 1 –º–µ—Å—è—Ü)
8. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ extensions –∏–∑ public –≤ extensions —Å—Ö–µ–º—É
9. –£–¥–∞–ª–∏—Ç—å production console.log (–∫—Ä–æ–º–µ error –≤ catch)
10. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫—Ä—É–ø–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (norm-ref-extractor, legal-chat)
11. –ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ RLS –¥–ª—è case_comments.is_internal, evidence_registry

---

*–ê—É–¥–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω 2025-02-15. –°–ª–µ–¥—É—é—â–∏–π —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∞—É–¥–∏—Ç: —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞ –∏–ª–∏ –ø–æ—Å–ª–µ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ RLS/Edge Functions.*
