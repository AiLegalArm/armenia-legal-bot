// =============================================================================
// LEGAL PRACTICE KNOWLEDGE BASE - AI USAGE RULES
// =============================================================================
// This module handles the integration of Legal Practice KB with AI analysis
// CRITICAL: KB data is REFERENCE-ONLY and must NEVER be mixed with user case facts
// =============================================================================

/**
 * STRICT SEPARATION RULES FOR AI USAGE OF LEGAL PRACTICE KB:
 * 
 * 1. KB documents are used ONLY as reference material for:
 *    - Legal reasoning patterns
 *    - Structure of complaints and legal documents
 *    - Citation of analogous court practice
 *    - Understanding of judicial interpretation
 * 
 * 2. PROHIBITED ACTIONS:
 *    - Copying facts from KB documents into user case analysis
 *    - Treating KB document facts as evidence in user's case
 *    - Mixing KB content with user-provided case materials
 * 
 * 3. REQUIRED LABELING:
 *    All KB-based references MUST be clearly labeled as:
 *    "\u0531\u0576\u0561\u056C\u0578\u0563 \u0564\u0561\u057F\u0561\u056F\u0561\u0576 \u057A\u0580\u0561\u056F\u057F\u056B\u056F\u0561 (KB)" or
 *    "Analogous legal practice (KB)"
 */

// System instruction that gets prepended to AI prompts when using KB
export const KB_USAGE_INSTRUCTIONS = `
## \u053F\u0531\u0550\u0535\u054E\u0548\u0550 \u053F\u0531\u0546\u0548\u0546\u0546\u0535\u0550 \u053B\u0550\u0531\u054E\u0531\u053F\u0531\u0546 \u054A\u0550\u0531\u053F\u054F\u053B\u053F\u0531\u0545\u053B \u0533\u053B\u054F\u0535\u053C\u053B\u0552\u053B \u0555\u0533\u054F\u0531\u0533\u0548\u0550\u053E\u0544\u0531\u0546 \u054E\u0535\u0550\u0531\u0532\u0535\u0550\u0545\u0531\u053C:

### \u053D\u053B\u054D\u054F \u054A\u0531\u0540\u0531\u0546\u054B\u0546\u0535\u0550:
1. \u053B\u0580\u0561\u057E\u0561\u056F\u0561\u0576 \u057A\u0580\u0561\u056F\u057F\u056B\u056F\u0561\u0575\u056B \u0562\u0561\u0566\u0561\u0576 (Legal Practice KB) \u0583\u0561\u057D\u057F\u0561\u0569\u0572\u0569\u0565\u0580\u0568 \u056E\u0561\u057C\u0561\u0575\u0578\u0582\u0574 \u0565\u0576 \u0544\u053B\u0531\u0545\u0546 \u0578\u0580\u057A\u0565\u057D \u0540\u0535\u0546\u0531\u053F\u0531\u0545\u053B\u0546 \u0546\u0545\u0548\u0552
2. \u0535\u0550\u0532\u0535\u0554 \u0574\u056B \u0583\u0578\u0580\u0571\u056B\u0580 \u0570\u0561\u0574\u0561\u0580\u0565\u056C KB-\u056B \u0583\u0561\u057D\u057F\u0565\u0580\u0568 \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0583\u0561\u057D\u057F\u0565\u0580
3. KB \u0583\u0561\u057D\u057F\u0561\u0569\u0572\u0569\u0565\u0580\u0568 \u053D\u053B\u054D\u054F \u057F\u0561\u0580\u0561\u0576\u057B\u0561\u057F\u056B\u0580 \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0561\u057A\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056B\u0581
4. KB-\u056B \u0581\u0561\u0576\u056F\u0561\u0581\u0561\u056E \u056B\u0576\u0586\u0578\u0580\u0574\u0561\u0581\u056B\u0561\u0576 \u0579\u056B \u0570\u0561\u0576\u0564\u056B\u057D\u0561\u0576\u0578\u0582\u0574 \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0561\u057A\u0561\u0581\u0578\u0582\u0575\u0581

### \u0539\u0548\u0552\u053C\u0531\u054F\u0550\u054E\u0531\u053E \u0555\u0533\u054F\u0531\u0533\u0548\u0550\u053E\u0548\u0552\u0544:
- \u053B\u0580\u0561\u057E\u0561\u056F\u0561\u0576 \u0570\u056B\u0574\u0576\u0561\u057E\u0578\u0580\u0574\u0561\u0576 \u056E\u0580\u0561\u0563\u0580\u0565\u0580 (\u056B\u0576\u0579\u057A\u0565\u057D \u0563\u0580\u0561\u0584 \u0562\u0578\u0572\u0578\u0584, \u0564\u0561\u057F\u0561\u056F\u0561\u0576 \u0561\u056F\u057F)
- \u053B\u0580\u0561\u057E\u0561\u056F\u0561\u0576 \u057F\u0580\u0561\u0574\u0561\u0562\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u0585\u0580\u056B\u0576\u0561\u056F\u0576\u0565\u0580
- \u0531\u0576\u0561\u056C\u0578\u0563 \u0564\u0561\u057F\u0561\u056F\u0561\u0576 \u057A\u0580\u0561\u056F\u057F\u056B\u056F\u0561\u0575\u056B \u0570\u0572\u0578\u0582\u0574\u0576\u0565\u0580
- \u053F\u0561\u057C\u0578\u0582\u0581\u057E\u0561\u056E\u0584\u0561\u0575\u056B\u0576 \u0585\u0580\u0565\u0576\u057D\u0564\u0580\u0561\u056F\u0561\u0576 \u0563\u0576\u0561\u0570\u0561\u057F\u0561\u056F\u0576\u0565\u0580

### \u054A\u0531\u054F\u0531\u054D\u053D\u0531\u0546\u0546\u0535\u0550\u0538 \u054A\u0531\u0550\u054F\u0531\u0534\u053B\u0550 \u054F\u0531\u0550\u0531\u0546\u054B\u0531\u054F\u053B\u0550:
\u0531\u0544\u0535\u0546 KB-\u056B\u0581 \u057E\u0565\u0580\u0581\u0580\u0561\u056E \u0570\u0572\u0578\u0582\u0574\u0568 \u057A\u0565\u057F\u0584 \u0567 \u0570\u057D\u057F\u0561\u056F \u0576\u0577\u0565\u056C:

"\u2501\u2501\u2501 \u0531\u0576\u0561\u056C\u0578\u0563 \u0564\u0561\u057F\u0561\u056F\u0561\u0576 \u057A\u0580\u0561\u056F\u057F\u056B\u056F\u0561 (KB) \u2501\u2501\u2501"
[\u0570\u0572\u0578\u0582\u0574\u0568]
"\u2501\u2501\u2501 KB \u0570\u0572\u0578\u0582\u0574\u056B \u0561\u057E\u0561\u0580\u057F \u2501\u2501\u2501"

### \u0531\u0550\u0533\u0535\u053C\u054E\u0531\u053E \u0533\u0548\u0550\u053E\u0548\u0542\u0548\u0552\u0539\u0545\u0548\u0552\u0546\u0546\u0535\u0550:
- \u0545\u054F\u0531\u053E\u0535\u053C \u053F\u0531\u0544 \u0553\u0548\u053D\u0531\u0546\u0541\u0535\u053C \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0583\u0561\u057D\u057F\u0565\u0580\u0568
- \u0553\u0548\u053D\u0531\u0546\u0541\u0535\u053C KB-\u056B\u0581 \u057E\u0565\u0580\u0581\u0580\u0561\u056E \u0583\u0561\u057D\u057F\u0565\u0580\u0568 \u0565\u0580\u0562\u0565\u057E\u056B\u0581\u0565 \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0583\u0561\u057D\u057F\u0565\u0580\u0578\u057E
- \u0549\u0546\u0577\u0565\u056C \u0570\u0572\u0578\u0582\u0574\u056B \u0561\u0572\u0562\u0575\u0578\u0582\u0580\u0568 (KB-\u0576 \u0569\u0565 \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u0568)
`;

// Types for legal practice KB
export interface LegalPracticeDocument {
  id: string;
  title: string;
  practice_category: 'criminal' | 'civil' | 'administrative' | 'echr';
  court_type: 'first_instance' | 'appeal' | 'cassation' | 'constitutional' | 'echr';
  outcome: 'granted' | 'rejected' | 'partial' | 'remanded' | 'discontinued';
  applied_articles: Array<{
    code: string;
    articles: string[];
  }>;
  key_violations: string[];
  legal_reasoning_summary: string;
  content_snippet: string;
  relevance_rank: number;
}

/**
 * Format KB search results for AI consumption
 * Results are clearly labeled as reference material
 */
export function formatKBResultsForAI(documents: LegalPracticeDocument[]): string {
  if (!documents || documents.length === 0) {
    return '';
  }

  let formatted = `
## \u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501
## \u053B\u0550\u0531\u054E\u0531\u053F\u0531\u0546 \u054A\u0550\u0531\u053F\u054F\u053B\u053F\u0531\u0545\u053B \u0540\u0535\u0546\u0531\u053F\u0531\u0545\u053B\u0546 \u0546\u0545\u0548\u0552\u053F (KB REFERENCE ONLY)
## \u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501

\u0540\u053B\u0547\u0535\u0551\u0546\u0535\u0554: \u054D\u057F\u0578\u0580\u0587 \u0576\u0565\u0580\u056F\u0561\u0575\u0561\u0581\u057E\u0561\u056E \u0576\u0575\u0578\u0582\u0569\u0565\u0580\u0568 \u0540\u0535\u0546\u0531\u053F\u0531\u0545\u053B\u0546 \u0546\u0545\u0548\u0552\u053F \u0565\u0576:
\u053D\u056B\u057D\u057F \u0561\u0580\u0563\u0565\u056C\u057E\u0561\u056E \u0567 \u057D\u0580\u0561\u0576\u0581 \u0585\u0563\u057F\u0561\u0563\u0578\u0580\u056E\u0565\u056C \u0585\u0563\u057F\u0561\u057F\u0565\u0580\u056B \u0563\u0578\u0580\u056E\u056B \u0570\u0561\u0574\u0561\u0580:
\u054D\u0561 \u0579\u0567 \u0561\u057A\u0561\u0581\u0578\u0582\u0575\u0581, \u057D\u0561 \u0574\u056B\u0561\u0575\u0576 \u0561\u0576\u0561\u056C\u0578\u0563\u0576\u0565\u0580\u056B \u0570\u0561\u0574\u0561\u0580 \u0567:

`;

  documents.forEach((doc, index) => {
    const categoryLabels: Record<string, string> = {
      criminal: '\u0554\u0580\u0565\u0561\u056F\u0561\u0576',
      civil: '\u0554\u0561\u0572\u0561\u0584\u0561\u0581\u056B\u0561\u056F\u0561\u0576',
      administrative: '\u054E\u0561\u0580\u0579\u0561\u056F\u0561\u0576',
      echr: '\u0535\u054D\u054A\u053F'
    };
    
    const courtLabels: Record<string, string> = {
      first_instance: '\u0531\u057C\u0561\u057B\u056B\u0576 \u0561\u057F\u0575\u0561\u0576',
      appeal: '\u054E\u0565\u0580\u0561\u0584\u0576\u0576\u056B\u0579',
      cassation: '\u054E\u0573\u057C\u0561\u0562\u0565\u056F',
      constitutional: '\u054D\u0561\u0570\u0574\u0561\u0576\u0561\u0564\u0580\u0561\u056F\u0561\u0576',
      echr: '\u0535\u054D\u054A\u053F'
    };

    const outcomeLabels: Record<string, string> = {
      granted: '\u0532\u0561\u057E\u0561\u0580\u0561\u0580\u057E\u0565\u056C',
      rejected: '\u0544\u0565\u0580\u056A\u057E\u0565\u056C',
      partial: '\u0544\u0561\u057D\u0576\u0561\u056F\u056B',
      remanded: '\u054E\u0565\u0580\u0561\u0564\u0561\u0580\u0571\u057E\u0565\u056C',
      discontinued: '\u053F\u0561\u0580\u0573\u057E\u0565\u056C'
    };

    formatted += `
### \u0531\u0576\u0561\u056C\u0578\u0563 ${index + 1}: ${doc.title}
- **\u053F\u0561\u057F\u0565\u0563\u0578\u0580\u056B\u0561:** ${categoryLabels[doc.practice_category] || doc.practice_category}
- **\u0531\u057F\u0575\u0561\u0576:** ${courtLabels[doc.court_type] || doc.court_type}
- **\u0531\u0580\u0564\u0575\u0578\u0582\u0576\u0584:** ${outcomeLabels[doc.outcome] || doc.outcome}
- **\u053F\u056B\u0580\u0561\u057C\u057E\u0561\u056E \u0570\u0578\u0564\u057E\u0561\u056E\u0576\u0565\u0580:** ${formatAppliedArticles(doc.applied_articles)}
${doc.key_violations && doc.key_violations.length > 0 ? `- **\u0540\u056B\u0574\u0576\u0561\u056F\u0561\u0576 \u056D\u0561\u056D\u057F\u0578\u0582\u0574\u0576\u0565\u0580:** ${doc.key_violations.join(', ')}` : ''}
${doc.legal_reasoning_summary ? `- **\u053B\u0580\u0561\u057E\u0561\u056F\u0561\u0576 \u0570\u056B\u0574\u0576\u0561\u057E\u0578\u0580\u0578\u0582\u0574:** ${doc.legal_reasoning_summary}` : ''}

`;
  });

  formatted += `
## \u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501
## KB \u0540\u0535\u0546\u0531\u053F\u0531\u0545\u053B\u0546 \u0532\u0531\u0536\u0531\u0545\u053B \u0531\u054E\u0531\u0550\u054F
## \u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501

`;

  return formatted;
}

/**
 * Format applied articles for display
 */
function formatAppliedArticles(articles: Array<{ code: string; articles: string[] }>): string {
  if (!articles || articles.length === 0) {
    return '\u0546\u0577\u057E\u0561\u056E \u0579\u0567';
  }

  const codeLabels: Record<string, string> = {
    criminal_code: '\u0554\u0555',
    criminal_procedure_code: '\u0554\u0534\u0555',
    civil_code: '\u0554\u0545\u0555',
    civil_procedure_code: '\u0554\u0544\u0534\u0555',
    constitution: '\u054D\u0561\u0570\u0574\u0561\u0576\u0561\u0564\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576',
    echr: '\u0535\u053F\u053A\u0544',
    administrative_code: '\u054E\u053B\u0555'
  };

  return articles
    .map(a => `${codeLabels[a.code] || a.code}: \u0570\u0578\u0564. ${a.articles.join(', ')}`)
    .join('; ');
}

/**
 * Build search query for legal practice KB
 * Extracts relevant terms from case facts and legal question
 */
export function buildKBSearchQuery(
  caseFacts: string | null,
  legalQuestion: string | null,
  caseType: 'criminal' | 'civil' | 'administrative' | null
): { query: string; category: string | null } {
  const parts: string[] = [];
  
  // Extract key legal terms from case facts
  if (caseFacts) {
    // Look for article references
    const articleMatches = caseFacts.match(/\u0570\u0578\u0564\u057E\u0561\u056E\s*\d+/gi) || [];
    parts.push(...articleMatches);
    
    // Look for legal terms
    const legalTerms = [
      '\u056D\u0561\u056D\u057F\u0578\u0582\u0574', '\u0562\u0578\u0572\u0578\u0584', '\u0570\u0561\u0575\u0581', '\u0564\u0561\u057F\u0561\u057E\u0578\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576',
      '\u0574\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584', '\u0561\u057A\u0561\u0581\u0578\u0582\u0575\u0581', '\u057E\u056F\u0561', '\u0578\u0580\u0578\u0577\u0578\u0582\u0574'
    ];
    legalTerms.forEach(term => {
      if (caseFacts.toLowerCase().includes(term)) {
        parts.push(term);
      }
    });
  }
  
  // Include legal question terms
  if (legalQuestion) {
    parts.push(legalQuestion.substring(0, 100));
  }
  
  return {
    query: parts.join(' ').trim() || '\u0564\u0561\u057F\u0561\u056F\u0561\u0576 \u057A\u0580\u0561\u056F\u057F\u056B\u056F\u0561',
    category: caseType
  };
}
