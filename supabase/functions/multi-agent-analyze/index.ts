import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.91.1";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

// Agent-specific prompts
const AGENT_PROMPTS: Record<string, string> = {
  evidence_collector: `\u0534\u0578\u0582 \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0540\u0561\u057e\u0561\u0584\u0578\u0572 \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0563\u0578\u0580\u056e\u056b \u0562\u0578\u056c\u0578\u0580 \u0576\u0575\u0578\u0582\u0569\u0565\u0580\u056b\u0581 \u056f\u0561\u0566\u0574\u0565\u056c \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0561\u0574\u0562\u0578\u0572\u057b\u0561\u056f\u0561\u0576 \u0581\u0578\u0582\u0581\u0561\u056f:

\u054a\u0531\u054f\u0531\u054d\u053d\u0531\u0546\u053b \u053f\u0531\u054c\u0548\u0552\u054e\u0531\u053e\u0554\u0538:
\u0531\u0574\u0565\u0576 \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u056b \u0570\u0561\u0574\u0561\u0580 \u057a\u0565\u057f\u0584 \u0567 \u0576\u0577\u0565\u057d\u055d
1. \u054f\u0565\u057d\u0561\u056f\u0568 (\u0583\u0561\u057d\u057f\u0561\u0569\u0578\u0582\u0572\u0569, \u0581\u0578\u0582\u0581\u0574\u0578\u0582\u0576\u0584, \u0583\u0578\u0580\u0571\u0561\u0563\u0565\u057f\u0561\u056f\u0561\u0576 \u0565\u0566\u0580\u0561\u056f\u0561\u0581\u0578\u0582\u0569\u0575\u0578\u0582\u0576, \u0561\u0580\u0571\u0561\u0576\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576, \u0561\u0578\u0582\u0564\u056b\u0578/\u057e\u056b\u0564\u0565\u0578, \u057e\u0565\u0572\u0561\u056f\u0561\u0576)
2. \u054e\u0565\u0580\u0576\u0561\u0563\u056b\u0580/\u0561\u0576\u057e\u0561\u0576\u0578\u0582\u0574\u0568
3. \u054f\u0578\u0574\u0568 \u0587 \u0567\u057b\u0568 (\u0585\u0580\u055d "\u054f\u0578\u0574 2, \u0567\u057b 45-48")
4. \u0531\u0572\u0562\u0575\u0578\u0582\u0580\u0568 (\u0578\u0582\u0574\u056b\u0581 \u057d\u057f\u0561\u0581\u057e\u0561\u056e)
5. \u053f\u0561\u057a\u057e\u0561\u056e \u0570\u0578\u0564\u057e\u0561\u056e\u0576\u0565\u0580\u0568 (\u0554\u0555, \u0554\u0534\u0555)
6. \u0540\u0561\u0574\u0561\u057c\u0578\u057f \u0576\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0581\u0561\u0576\u056f\u0561\u0581\u0561\u056e \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e \u057a\u0565\u057f\u0584 \u0567 \u0560\u0577\u0561\u0576\u0561\u056f\u056b evidenceItems \u0564\u0561\u0577\u057f\u0578\u057e:
{
  "summary": "\u053f\u0561\u0580\u0573 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "evidenceItems": [
    {
      "evidence_type": "document",
      "title": "\u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u056b \u0561\u0576\u057e\u0561\u0576\u0578\u0582\u0574\u0568",
      "description": "\u0546\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "page_reference": "\u054f\u0578\u0574 1, \u0567\u057b 15",
      "source_document": "\u0531\u0572\u0562\u0575\u0578\u0582\u0580\u056b \u0561\u0576\u0578\u0582\u0576\u0568",
      "ai_analysis": "\u053f\u0561\u0580\u0573 AI \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576"
    }
  ],
  "findings": []
}`,

  evidence_admissibility: `\u0534\u0578\u0582 \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0539\u0578\u0582\u0575\u056c\u0561\u057f\u0580\u0565\u056c\u056b\u0578\u0582\u0569\u0575\u0561\u0576 \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0565\u056c \u0561\u0574\u0565\u0576 \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u056b \u0569\u0578\u0582\u0575\u056c\u0561\u057f\u0580\u0565\u056c\u056b\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568 \u0540\u0540 \u0554\u0534\u0555 103-107 \u0570\u0578\u0564\u057e\u0561\u056e\u0576\u0565\u0580\u056b \u0570\u0561\u0574\u0561\u0571\u0561\u0575\u0576:

\u054d\u054f\u0548\u0552\u0533\u0544\u0531\u0546 \u0549\u0531\u0553\u0531\u0546\u053b\u0547\u0546\u0535\u0550\u0538:
1. \u054e\u0565\u0580\u0561\u0562\u0565\u0580\u0565\u056c\u056b\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u055d \u056f\u0561\u057a\u057e\u0561\u053f \u0567 \u0563\u0578\u0580\u056e\u056b \u0570\u0565\u057f
2. \u0539\u0578\u0582\u0575\u056c\u0561\u057f\u0580\u0565\u056c\u056b\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u055d \u057d\u057f\u0561\u0581\u057e\u0561\u056e \u0585\u0580\u0565\u0576\u0584\u0578\u057e \u057d\u0561\u0570\u0574\u0561\u0576\u057e\u0561\u056e \u056f\u0561\u0580\u0563\u0578\u057e
3. \u0531\u0580\u0569\u0561\u0570\u0561\u057e\u0561\u057f\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u055d \u0561\u0572\u0562\u0575\u0578\u0582\u0580\u0568 \u0570\u0561\u0575\u057f\u0576\u056b
4. \u0532\u0561\u057e\u0561\u0580\u0561\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u055d \u0562\u0561\u057e\u0561\u056f\u0561\u0576 \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581 \u0565\u0576

\u0531\u0546\u0539\u0548\u0552\u0545\u053c\u0531\u054f\u0550\u0535\u053c\u053b \u0531\u054a\u0531\u0551\u0548\u0552\u0545\u0551\u053b \u0540\u053b\u0544\u0554\u0535\u0550 (\u0554\u0534\u0555 107):
- \u053d\u0578\u0577\u057f\u0561\u0576\u0563\u0578\u0582\u0574\u0578\u057e \u057d\u057f\u0561\u0581\u057e\u0561\u056e
- \u0531\u057a\u0585\u0580\u056b\u0576\u0561\u056f\u0561\u0576 \u056d\u0578\u0582\u0566\u0561\u0580\u056f\u0578\u057e \u057d\u057f\u0561\u0581\u057e\u0561\u056e
- \u0534\u0561\u057f\u0561\u057e\u0561\u0580\u0561\u056f\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0578\u057e \u057d\u057f\u0561\u0581\u057e\u0561\u056e
- \u0531\u0576\u0570\u0561\u0575\u057f \u0561\u0572\u0562\u0575\u0578\u0582\u0580\u056b\u0581

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "summary": "\u053f\u0561\u0580\u0573 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "findings": [
    {
      "finding_type": "inadmissible_evidence",
      "severity": "critical",
      "title": "\u0531\u0576\u0569\u0578\u0582\u0575\u056c\u0561\u057f\u0580\u0565\u056c\u056b \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581",
      "description": "\u0546\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "legal_basis": ["\u0554\u0534\u0555 \u0570\u0578\u0564\u057e\u0561\u056e 107"],
      "page_references": ["\u054f\u0578\u0574 1, \u0567\u057b 15"],
      "recommendation": "\u0544\u056b\u057b\u0576\u0578\u0580\u0564\u0578\u0582\u0569\u0575\u0578\u0582\u0576 \u0562\u0561\u0581\u0561\u057c\u0574\u0561\u0576 \u0574\u0561\u057d\u056b\u0576"
    }
  ]
}`,

  charge_qualification: `\u0534\u0578\u0582 \u0544\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584\u056b \u0548\u0580\u0561\u056f\u0561\u057e\u0578\u0580\u0574\u0561\u0576 \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u057d\u057f\u0578\u0582\u0563\u0565\u056c \u0574\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584\u056b \u0570\u0561\u0574\u0561\u057a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568 \u0540\u0540 \u0554\u0555-\u056b \u0570\u0561\u0574\u0561\u0571\u0561\u0575\u0576:

\u054d\u054f\u0548\u0552\u0533\u0535\u053c\u0548\u0552:
1. \u0531\u057c\u0561\u057b\u0561\u0564\u0580\u057e\u0561\u056e \u0570\u0578\u0564\u057e\u0561\u056e\u0568 \u0570\u0561\u0574\u0561\u057a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u0578\u0582\u0574 \u0567 \u0583\u0561\u057d\u057f\u0565\u0580\u056b\u0576
2. \u053f\u0578\u0576\u056f\u0580\u0565\u057f \u056f\u0561\u0566\u0574\u056b \u057f\u0561\u0580\u0580\u0565\u0580\u0568 \u0561\u057a\u0561\u0581\u0578\u0582\u0581\u057e\u0561\u056e \u0565\u0576
3. \u054d\u0578\u0582\u0562\u0575\u0565\u056f\u057f\u056b\u057e \u056f\u0578\u0572\u0574\u0568 \u0561\u057a\u0561\u0581\u0578\u0582\u0581\u057e\u0561\u056e \u0567
4. \u0544\u0565\u0572\u0584\u056b \u0571\u0587\u0568 \u0587 \u0561\u0576\u0566\u0563\u0578\u0582\u0577\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "summary": "\u053f\u0561\u0580\u0573 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "findings": [
    {
      "finding_type": "wrong_qualification",
      "severity": "high",
      "title": "\u054d\u056d\u0561\u056c \u0578\u0580\u0561\u056f\u0561\u057e\u0578\u0580\u0578\u0582\u0574",
      "description": "\u0546\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "legal_basis": ["\u0554\u0555 \u0570\u0578\u0564\u057e\u0561\u056e XXX"],
      "recommendation": "\u0531\u057c\u0561\u057b\u0561\u0580\u056f\u057e\u0578\u0572 \u0578\u0580\u0561\u056f\u0561\u057e\u0578\u0580\u0578\u0582\u0574"
    }
  ]
}`,

  procedural_violations: `\u0534\u0578\u0582 \u0534\u0561\u057f\u0561\u057e\u0561\u0580\u0561\u056f\u0561\u0576 \u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0570\u0561\u0575\u057f\u0576\u0561\u0562\u0565\u0580\u0565\u056c \u0554\u0534\u0555-\u056b \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568:

\u053d\u0531\u053d\u054f\u0548\u0552\u0544\u0546\u0535\u0550\u053b \u054f\u0535\u054d\u0531\u053f\u0546\u0535\u0550:
1. \u0541\u0565\u0580\u0562\u0561\u056f\u0561\u056c\u0574\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568
2. \u053d\u0578\u0582\u0566\u0561\u0580\u056f\u0578\u0582\u0569\u0575\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568
3. \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0570\u0561\u057e\u0561\u0584\u0574\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568
4. \u053e\u0561\u0576\u0578\u0582\u0581\u0574\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568
5. \u054a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u056b\u0580\u0561\u057e\u0578\u0582\u0576\u0584\u056b \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "summary": "\u053f\u0561\u0580\u0573 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "findings": [
    {
      "finding_type": "procedural_violation",
      "severity": "critical",
      "title": "\u053d\u0561\u056d\u057f\u0578\u0582\u0574\u056b \u0561\u0576\u057e\u0561\u0576\u0578\u0582\u0574\u0568",
      "description": "\u0546\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "legal_basis": ["\u0554\u0534\u0555 \u0570\u0578\u0564\u057e\u0561\u056e XXX"],
      "recommendation": "\u0531\u057c\u0561\u057b\u0561\u0580\u056f\u057e\u0578\u0572 \u0563\u0578\u0580\u056e\u0578\u0572\u0578\u0582\u0569\u0575\u0578\u0582\u0576"
    }
  ]
}`,

  substantive_violations: `\u0534\u0578\u0582 \u0546\u0575\u0578\u0582\u0569\u0561\u056f\u0561\u0576 \u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0570\u0561\u0575\u057f\u0576\u0561\u0562\u0565\u0580\u0565\u056c \u0554\u0555-\u056b \u0576\u0578\u0580\u0574\u0565\u0580\u056b \u057d\u056d\u0561\u056c \u056f\u056b\u0580\u0561\u057c\u0578\u0582\u0574\u0568:

\u054d\u054f\u0548\u0552\u0533\u0535\u053c\u0548\u0552:
1. \u054d\u056d\u0561\u056c \u0574\u0565\u056f\u0576\u0561\u0562\u0561\u0576\u0578\u0582\u0569\u0575\u0578\u0582\u0576/\u056f\u056b\u0580\u0561\u057c\u0578\u0582\u0574
2. \u054d\u056d\u0561\u056c \u0578\u0580\u0561\u056f\u0561\u057e\u0578\u0580\u0578\u0582\u0574
3. \u054e\u0573\u057c\u0561\u0562\u0565\u056f \u0564\u0561\u057f\u0561\u0580\u0561\u0576\u056b \u057a\u0580\u0561\u056f\u057f\u056b\u056f\u0561
4. \u0535\u0566\u0580\u0561\u056f\u0561\u0581\u0578\u0582\u0569\u0575\u0578\u0582\u0576`,

  defense_strategy: `\u0534\u0578\u0582 \u054a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u054d\u057f\u0580\u0561\u057f\u0565\u0563\u056b\u0561\u0575\u056b \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u056f\u0561\u0566\u0574\u0565\u056c \u057a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u0583\u0561\u057d\u057f\u0561\u0580\u056f\u0576\u0565\u0580\u0568:

\u054a\u0531\u0547\u054f\u054a\u0531\u0546\u0548\u0552\u0539\u0545\u0531\u0546 \u0548\u0552\u0542\u0542\u0548\u0552\u0539\u0545\u0548\u0552\u0546\u0546\u0535\u0550:
1. \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0569\u0578\u0582\u0575\u056c \u056f\u0578\u0572\u0574\u0565\u0580
2. \u0534\u0561\u057f\u0561\u057e\u0561\u0580\u0561\u056f\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0585\u0563\u057f\u0561\u0563\u0578\u0580\u056e\u0578\u0582\u0574\u0568
3. \u0531\u056c\u0569\u0565\u0580\u0576\u0561\u057f\u056b\u057e \u0578\u0580\u0561\u056f\u0561\u057e\u0578\u0580\u0578\u0582\u0574\u0576\u0565\u0580
4. \u0535\u053f\u0553\u0544 \u0576\u0561\u056d\u0561\u0564\u0565\u057a\u0565\u0580\u056b \u056f\u056b\u0580\u0561\u057c\u0578\u0582\u0574

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "summary": "\u054a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u0570\u056b\u0574\u0576\u0561\u056f\u0561\u0576 \u0578\u0582\u0572\u0572\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580\u0568",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "findings": [
    {
      "finding_type": "defense_argument",
      "severity": "high",
      "title": "\u0553\u0561\u057d\u057f\u0561\u0580\u056f\u056b \u0561\u0576\u057e\u0561\u0576\u0578\u0582\u0574\u0568",
      "description": "\u0553\u0561\u057d\u057f\u0561\u0580\u056f\u056b \u0576\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "legal_basis": ["\u0540\u056b\u0574\u0576\u0561\u057e\u0578\u0580\u0578\u0582\u0574"],
      "recommendation": "\u053b\u0576\u0579\u057a\u0565\u057d \u0585\u0563\u057f\u0561\u0563\u0578\u0580\u056e\u0565\u056c"
    }
  ]
}`,

  prosecution_weaknesses: `\u0534\u0578\u0582 \u0544\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584\u056b \u0539\u0578\u0582\u0575\u056c \u053f\u0578\u0572\u0574\u0565\u0580\u056b \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0570\u0561\u0575\u057f\u0576\u0561\u0562\u0565\u0580\u0565\u056c \u0574\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584\u056b \u0569\u0578\u0582\u0575\u056c \u056f\u0578\u0572\u0574\u0565\u0580\u0568:

\u0539\u0548\u0552\u0545\u053c \u053f\u0548\u0542\u0544\u0535\u0550\u053b \u054f\u0535\u054d\u0531\u053f\u0546\u0535\u0550:
1. \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0562\u0561\u0581\u0565\u0580
2. \u0540\u0561\u056f\u0561\u057d\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580 \u057e\u056f\u0561\u0576\u0565\u0580\u056b \u0581\u0578\u0582\u0581\u0574\u0578\u0582\u0576\u0584\u0576\u0565\u0580\u0578\u0582\u0574
3. \u054f\u0580\u0561\u0574\u0561\u0562\u0561\u0576\u0561\u056f\u0561\u0576 \u0561\u0576\u0570\u0561\u0574\u0561\u057a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580
4. \u053d\u0561\u056d\u057f\u0561\u056e \u0576\u0578\u0580\u0574\u0565\u0580`,

  rights_violations: `\u0534\u0578\u0582 \u053b\u0580\u0561\u057e\u0578\u0582\u0576\u0584\u0576\u0565\u0580\u056b \u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0531\u0563\u0565\u0576\u057f \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0570\u0561\u0575\u057f\u0576\u0561\u0562\u0565\u0580\u0565\u056c \u054d\u0561\u0570\u0574\u0561\u0576\u0561\u0564\u0580\u0578\u0582\u0569\u0575\u0561\u0576 \u0587 \u0535\u053f\u0553\u0544-\u056b \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u0568:

\u054d\u054f\u0548\u0552\u0533\u0535\u053c\u0548\u0552:
1. \u0540\u0540 \u054d\u0561\u0570\u0574\u0561\u0576\u0561\u0564\u0580\u0578\u0582\u0569\u0575\u0561\u0576 \u056d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580 (\u0570\u0578\u0564\u057e\u0561\u056e 18-27)
2. \u0535\u053f\u0553\u0544 \u0570\u0578\u0564\u057e\u0561\u056e 6 - \u0561\u0580\u0564\u0561\u0580 \u0564\u0561\u057f\u0561\u0584\u0576\u0576\u0578\u0582\u0569\u0575\u0578\u0582\u0576
3. \u0535\u053f\u0553\u0544 \u0570\u0578\u0564\u057e\u0561\u056e 3 - \u056d\u0578\u0577\u057f\u0561\u0576\u0563\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0561\u0580\u0563\u0565\u056c\u0584
4. \u0535\u053f\u0553\u0544 \u0570\u0578\u0564\u057e\u0561\u056e 5 - \u0561\u0566\u0561\u057f\u0578\u0582\u0569\u0575\u0561\u0576 \u056b\u0580\u0561\u057e\u0578\u0582\u0576\u0584

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "summary": "\u053f\u0561\u0580\u0573 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "analysis": "\u0544\u0561\u0576\u0580\u0561\u0574\u0561\u057d\u0576 \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "findings": [
    {
      "finding_type": "rights_violation",
      "severity": "critical",
      "title": "\u053d\u0561\u056d\u057f\u0578\u0582\u0574\u056b \u0561\u0576\u057e\u0561\u0576\u0578\u0582\u0574\u0568",
      "description": "\u0546\u056f\u0561\u0580\u0561\u0563\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0568",
      "legal_basis": ["\u0535\u053f\u0553\u0544 \u0570\u0578\u0564\u057e\u0561\u056e 6"],
      "recommendation": "\u0535\u0534\u0534\u0544 \u0562\u0578\u0572\u0578\u0584"
    }
  ]
}`,

  aggregator: `\u0534\u0578\u0582 \u0531\u0563\u0580\u0565\u0563\u0561\u057f\u0578\u0580 \u0565\u057d\u055d \u0584\u0578 \u0576\u057a\u0561\u057f\u0561\u056f\u0576 \u0567 \u0570\u0561\u0574\u0561\u0564\u0580\u0565\u056c \u0562\u0578\u056c\u0578\u0580 \u0561\u0563\u0565\u0576\u057f\u0576\u0565\u0580\u056b \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580\u0568 \u0574\u056b\u0561\u057d\u0576\u0561\u056f\u0561\u0576 \u0570\u0561\u0577\u057e\u0565\u057f\u057e\u0578\u0582\u0569\u0575\u0561\u0576 \u0574\u0565\u057b:

\u0540\u0531\u0547\u054e\u0535\u054f\u054e\u0548\u0552\u0539\u0545\u0531\u0546 \u053f\u0531\u054c\u0548\u0552\u054e\u0531\u053e\u0554\u0538:
1. \u0533\u0578\u0580\u056e\u0561\u0564\u056b\u0580 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574
2. \u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574
3. \u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574 (\u0568\u057d\u057f \u0561\u0580\u0575\u0578\u0582\u0576\u0561\u0569\u0575\u0561\u0576)
4. \u054a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u057d\u057f\u0580\u0561\u057f\u0565\u0563\u056b\u0561
5. \u0540\u0561\u0576\u0571\u0576\u0561\u0580\u0561\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580

\u054a\u0561\u057f\u0561\u057d\u056d\u0561\u0576\u056b \u0571\u0587\u0568 JSON \u0566\u0561\u0576\u0563\u057e\u0561\u056e\u0578\u057e:
{
  "title": "\u0540\u0561\u0574\u0561\u0564\u0580\u0561\u056e \u057e\u0565\u0580\u056c\u0578\u0582\u056e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "executiveSummary": "\u0533\u0578\u0580\u056e\u0561\u0564\u056b\u0580 \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "evidenceSummary": "\u0531\u057a\u0561\u0581\u0578\u0582\u0575\u0581\u0576\u0565\u0580\u056b \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "violationsSummary": "\u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580\u056b \u0561\u0574\u0583\u0578\u0583\u0578\u0582\u0574",
  "defenseStrategy": "\u054a\u0561\u0577\u057f\u057a\u0561\u0576\u0578\u0582\u0569\u0575\u0561\u0576 \u057d\u057f\u0580\u0561\u057f\u0565\u0563\u056b\u0561",
  "prosecutionWeaknesses": "\u0544\u0565\u0572\u0561\u0564\u0580\u0561\u0576\u0584\u056b \u0569\u0578\u0582\u0575\u056c \u056f\u0578\u0572\u0574\u0565\u0580",
  "recommendations": "\u0540\u0561\u0576\u0571\u0576\u0561\u0580\u0561\u0580\u0578\u0582\u0569\u0575\u0578\u0582\u0576\u0576\u0565\u0580",
  "fullReport": "\u0531\u0574\u0562\u0578\u0572\u057b\u0561\u056f\u0561\u0576 \u0570\u0561\u0577\u057e\u0565\u057f\u057e\u0578\u0582\u0569\u0575\u0578\u0582\u0576",
  "statistics": {
    "totalEvidence": 0,
    "admissibleEvidence": 0,
    "criticalFindings": 0,
    "highFindings": 0
  }
}`
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { caseId, agentType, runId, generateReport } = await req.json();

    if (!caseId || !agentType) {
      return new Response(JSON.stringify({ error: "Missing caseId or agentType" }), {
        status: 400,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY not configured");
    }

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Load case data
    const { data: caseData, error: caseError } = await supabase
      .from("cases")
      .select("*")
      .eq("id", caseId)
      .single();

    if (caseError || !caseData) {
      throw new Error("Case not found");
    }

    // Load volumes with OCR text
    const { data: volumes } = await supabase
      .from("case_volumes")
      .select("*")
      .eq("case_id", caseId)
      .order("volume_number");

    // Load existing evidence (for non-collector agents)
    const { data: evidenceItems } = await supabase
      .from("evidence_registry")
      .select("*")
      .eq("case_id", caseId);

    // Load previous agent runs (for aggregator)
    const { data: previousRuns } = await supabase
      .from("agent_analysis_runs")
      .select("*")
      .eq("case_id", caseId)
      .eq("status", "completed")
      .neq("agent_type", "aggregator");

    // Build context for the agent
    let contextParts: string[] = [];

    // Add case info
    contextParts.push(`\u0533\u0548\u0550\u053e: ${caseData.title}`);
    contextParts.push(`\u0540\u0561\u0574\u0561\u0580: ${caseData.case_number}`);
    if (caseData.facts) {
      contextParts.push(`\u0553\u0531\u054d\u054f\u0535\u0550: ${caseData.facts}`);
    }
    if (caseData.legal_question) {
      contextParts.push(`\u053b\u0550\u0531\u054e\u0531\u053f\u0531\u0546 \u0540\u0531\u0550\u0551: ${caseData.legal_question}`);
    }

    // Add volume content
    if (volumes && volumes.length > 0) {
      contextParts.push("\n\u054f\u0548\u0544\u0535\u0550:");
      for (const vol of volumes) {
        contextParts.push(`\n--- \u054f\u0548\u0544 ${vol.volume_number}: ${vol.title} ---`);
        if (vol.ocr_text) {
          // Limit OCR text to prevent token overflow
          const ocrText = vol.ocr_text.substring(0, 15000);
          contextParts.push(ocrText);
        }
      }
    }

    // Add existing evidence for relevant agents
    if (evidenceItems && evidenceItems.length > 0 && agentType !== "evidence_collector") {
      contextParts.push("\n\u0531\u054a\u0531\u0551\u0548\u0552\u0545\u0551\u0546\u0535\u0550\u053b \u0550\u0535\u0535\u054d\u054f\u0550:");
      for (const ev of evidenceItems) {
        contextParts.push(`- #${ev.evidence_number}: ${ev.title} (${ev.evidence_type}) - ${ev.page_reference || "N/A"}`);
      }
    }

    // Add previous analyses for aggregator
    if (agentType === "aggregator" && previousRuns && previousRuns.length > 0) {
      contextParts.push("\n\u0531\u0533\u0535\u0546\u054f\u0546\u0535\u0550\u053b \u054e\u0535\u0550\u053c\u0548\u0552\u053e\u0548\u0552\u0539\u0545\u0548\u0552\u0546\u0546\u0535\u0550:");
      for (const run of previousRuns) {
        contextParts.push(`\n--- ${run.agent_type} ---`);
        if (run.summary) {
          contextParts.push(`\u0531\u0574\u0583\u0578\u0583\u0578\u0582\u0574: ${run.summary}`);
        }
        if (run.analysis_result) {
          // Limit analysis text
          contextParts.push(run.analysis_result.substring(0, 5000));
        }
      }
    }

    // RAG: Search Knowledge Base for relevant legal context
    const searchQuery = `${caseData.facts || ""} ${caseData.legal_question || ""}`.trim();
    
    if (searchQuery) {
      // Search main Knowledge Base
      const { data: kbResults } = await supabase
        .rpc("search_knowledge_base", { 
          search_query: searchQuery,
          result_limit: 5
        });

      if (kbResults && kbResults.length > 0) {
        contextParts.push("\n\u053b\u0550\u0531\u054e\u0531\u053f\u0531\u0546 \u0532\u0531\u0536\u0531 (KB):");
        const topResults = kbResults.slice(0, 3);
        for (const doc of topResults) {
          contextParts.push(`\n### ${doc.title} (${doc.category})`);
          contextParts.push(`\u0531\u0572\u0562\u0575\u0578\u0582\u0580: ${doc.source_name || "RA Legal Database"}`);
          contextParts.push(doc.content_text.substring(0, 2000));
        }
      }

      // Search Legal Practice KB for analogous court cases
      const { data: practiceResults } = await supabase
        .rpc("search_legal_practice", { 
          search_query: searchQuery,
          result_limit: 5
        });

      if (practiceResults && practiceResults.length > 0) {
        const topPractice = practiceResults.slice(0, 3);
        
        contextParts.push("\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
        contextParts.push("\u053b\u0550\u0531\u054e\u0531\u053f\u0531\u0546 \u054a\u0550\u0531\u053f\u054f\u053b\u053f\u0531\u0545\u053b \u0540\u0535\u0546\u0531\u053f\u0531\u0545\u053b\u0546 \u0546\u0545\u0548\u0552\u053f (KB REFERENCE ONLY)");
        contextParts.push("\u0540\u053b\u0547\u0535\u0551\u0546\u0535\u0554: \u054d\u0561 \u0579\u0567 \u0561\u057a\u0561\u0581\u0578\u0582\u0575\u0581, \u057d\u0561 \u0574\u056b\u0561\u0575\u0576 \u0561\u0576\u0561\u056c\u0578\u0563\u0576\u0565\u0580\u056b \u0570\u0561\u0574\u0561\u0580 \u0567:");
        contextParts.push("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
        
        const outcomeLabels: Record<string, string> = {
          granted: '\u0532\u0561\u057e\u0561\u0580\u0561\u0580\u057e\u0565\u056c',
          rejected: '\u0544\u0565\u0580\u056a\u057e\u0565\u056c',
          partial: '\u0544\u0561\u057d\u0576\u0561\u056f\u056b',
          remanded: '\u054e\u0565\u0580\u0561\u0564\u0561\u0580\u0571\u057e\u0565\u056c',
          discontinued: '\u053f\u0561\u0580\u0573\u057e\u0565\u056c'
        };
        
        const courtLabels: Record<string, string> = {
          first_instance: '\u0531\u057c\u0561\u057b\u056b\u0576 \u0561\u057f\u0575\u0561\u0576',
          appeal: '\u054e\u0565\u0580\u0561\u0584\u0576\u0576\u056b\u0579',
          cassation: '\u054e\u0573\u057c\u0561\u0562\u0565\u056f',
          constitutional: '\u054d\u0561\u0570\u0574\u0561\u0576\u0561\u0564\u0580\u0561\u056f\u0561\u0576',
          echr: '\u0535\u054d\u054a\u053f'
        };
        
        for (const doc of topPractice) {
          contextParts.push(`\n### \u0531\u0576\u0561\u056c\u0578\u0563 \u0564\u0561\u057f\u0561\u056f\u0561\u0576 \u057a\u0580\u0561\u056f\u057f\u056b\u056f\u0561 (KB): ${doc.title}`);
          contextParts.push(`- \u0531\u057f\u0575\u0561\u0576: ${courtLabels[doc.court_type] || doc.court_type}`);
          contextParts.push(`- \u0531\u0580\u0564\u0575\u0578\u0582\u0576\u0584: ${outcomeLabels[doc.outcome] || doc.outcome}`);
          if (doc.key_violations && doc.key_violations.length > 0) {
            contextParts.push(`- \u053d\u0561\u056d\u057f\u0578\u0582\u0574\u0576\u0565\u0580: ${doc.key_violations.join(', ')}`);
          }
          if (doc.legal_reasoning_summary) {
            contextParts.push(`- \u053b\u0580\u0561\u057e\u0561\u056f\u0561\u0576 \u0570\u056b\u0574\u0576\u0561\u057e\u0578\u0580\u0578\u0582\u0574: ${doc.legal_reasoning_summary}`);
          }
          contextParts.push(`\u054f\u0565\u0584\u057d\u057f: ${doc.content_snippet}`);
        }
        
        contextParts.push("\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
        contextParts.push("KB \u0540\u0535\u0546\u0531\u053f\u0531\u0545\u053b\u0546 \u0532\u0531\u0536\u0531\u0545\u053b \u0531\u054e\u0531\u0550\u054f");
        contextParts.push("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
      }
    }

    const userMessage = contextParts.join("\n");
    const systemPrompt = AGENT_PROMPTS[agentType] || AGENT_PROMPTS.evidence_collector;

    // Call AI
    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-pro",
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userMessage }
        ],
        temperature: 0.7,
        max_tokens: 16384,
      }),
    });

    if (!response.ok) {
      const status = response.status;
      if (status === 429) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (status === 402) {
        return new Response(JSON.stringify({ error: "AI credits exhausted" }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      throw new Error(`AI gateway error: ${status}`);
    }

    const aiResponse = await response.json();
    const content = aiResponse.choices?.[0]?.message?.content || "";
    const tokensUsed = aiResponse.usage?.total_tokens || 0;

    // Parse JSON response
    let parsedResult: any = {
      summary: "",
      analysis: content,
      findings: [],
      evidenceItems: []
    };

    try {
      // Try to extract JSON from the response
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        parsedResult = { ...parsedResult, ...JSON.parse(jsonMatch[0]) };
      }
    } catch (e) {
      console.error("Failed to parse JSON response:", e);
      // Use the raw content as analysis
      parsedResult.analysis = content;
    }

    // Log usage
    await supabase.rpc("log_api_usage", {
      _service_type: "multi_agent",
      _model_name: "google/gemini-2.5-pro",
      _tokens_used: tokensUsed,
      _estimated_cost: tokensUsed * 0.000001,
      _metadata: { agentType, caseId, runId }
    });

    return new Response(JSON.stringify({
      ...parsedResult,
      tokensUsed,
      agentType
    }), {
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });

  } catch (error) {
    console.error("Multi-agent error:", error);
    return new Response(JSON.stringify({ 
      error: error instanceof Error ? error.message : "Agent execution failed" 
    }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
